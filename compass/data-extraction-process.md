# Compass 데이터 추출 프로세스

공시 데이터가 수집되어 저장되기까지의 전체 과정을 설명하는 문서.
시스템 구조에 대한 이해가 필요한 경우 [database-design.md](./database-design.md) 참고.

---

## 목차

1. [개요](#1-개요)
2. [전체 흐름](#2-전체-흐름)
3. [단계별 상세](#3-단계별-상세)
4. [상태 관리](#4-상태-관리)
5. [오류 처리와 재시도](#5-오류-처리와-재시도)
6. [실행 방법](#6-실행-방법)

---

## 1. 개요

### 목표

금융감독원 전자공시시스템(DART)에 제출된 공시 문서에서 필요한 정보를 자동으로 추출하여 데이터베이스에 저장.

### 현재 지원 범위

| 데이터 종류 | 원천 문서 | 추출 정보 |
|------------|----------|----------|
| 회사채 발행 | 증권신고서(채무증권) | 발행 금액, 금리, 주관사, 수요예측 결과 등 |

### 향후 확장 예정

- 경영실적: 사업보고서, 반기보고서, 분기보고서
- 지배구조: 임원 현황, 최대주주 변동
- IR 정보: 기업 IR 페이지

---

## 2. 전체 흐름

```
┌─────────────────────────────────────────────────────────────────────┐
│                        데이터 추출 전체 흐름                          │
└─────────────────────────────────────────────────────────────────────┘

  ① 모니터링        ② 다운로드         ③ 파싱           ④ 저장
┌──────────┐     ┌──────────┐     ┌──────────┐     ┌──────────┐
│   DART   │     │   ZIP    │     │   XML    │     │   DB     │
│  검색    │ ──▶ │  다운로드 │ ──▶ │  분석    │ ──▶ │  저장    │
│          │     │  + 압축해제│     │  + 추출  │     │          │
└──────────┘     └──────────┘     └──────────┘     └──────────┘
     │                │                │                │
     ▼                ▼                ▼                ▼
 신규 공시 발견    문서 파일 확보    구조화된 데이터    분석 가능 상태
```

### 흐름 요약

1. **모니터링**: DART에서 신규 공시 문서 검색
2. **다운로드**: 해당 문서의 원본 파일(ZIP) 다운로드 및 압축 해제
3. **파싱**: XML 파일을 읽고 필요한 정보 추출
4. **저장**: 추출된 데이터를 데이터베이스에 저장

---

## 3. 단계별 상세

### 3.1 모니터링 단계

**목적**: 새로 제출된 공시 문서 발견

**과정**:
1. DART 검색 페이지에 조회 요청
2. 검색 조건: 문서 종류, 기간
3. 검색 결과에서 접수번호, 회사명, 보고서명 추출

**결과 예시**:
```
검색 결과: 5건

[1] 삼성전자 - 증권신고서(채무증권)
    접수번호: 20250919000604
    접수일자: 2025-09-19

[2] LG전자 - 증권신고서(채무증권)
    접수번호: 20250920000123
    접수일자: 2025-09-20
```

### 3.2 중복 확인

**목적**: 이미 처리한 문서를 다시 처리하지 않음

**과정**:
1. 접수번호로 기존 처리 이력 조회
2. 이력이 있으면 건너뛰기
3. 이력이 없으면 다음 단계 진행

### 3.3 다운로드 단계

**목적**: 공시 문서의 원본 파일 확보

**과정**:
1. OpenDART API를 통해 ZIP 파일 다운로드
2. 임시 폴더에 저장
3. ZIP 파일 압축 해제하여 XML 파일 추출
4. 임시 파일 삭제 (용량 확보)

**결과**:
- 원본 XML 파일이 지정된 폴더에 저장됨

### 3.4 파싱 및 추출 단계

**목적**: XML 파일에서 필요한 정보를 구조화된 형태로 추출

**과정**:

#### 문서 종류 판별
XML 내용을 분석하여 문서 종류 결정:

| 문서 종류 | 특징 | 추출 내용 |
|----------|------|----------|
| 최초 제출 | 일반적인 증권신고서 | 발행 예정 조건 |
| 발행조건 확정 | 수요예측 결과 반영 | 확정 금리, 발행 금액 |
| 기준금리 확정 | 변동금리채 금리 확정 | 결정 이율 |
| 정정 보고 | 기존 내용 수정 | 변경된 항목 |

#### 추출 정보 (회사채 기준)

**기업 정보**:
- 회사명
- 회사 코드 (DART 고유번호)
- 최대 발행 한도

**회차별 정보** (하나의 신고서에 여러 회차 포함 가능):
- 회차 번호
- 채권 명칭
- 청약일, 상환일
- 신용등급
- 금리 (희망 범위 또는 확정 금리)
- 발행 금액
- 주관사 정보 (대표주관사, 공동주관사, 인수금액, 수수료)

**부가 정보**:
- 자금 사용 목적
- 발행 제비용
- 수요예측 결과 (경쟁률 등)

### 3.5 검증 단계

**목적**: 추출된 데이터의 정합성 확인

**검증 항목**:
- 필수 정보 누락 여부 (회사명, 회차 정보 등)
- 데이터 형식 적합성 (날짜, 금액 등)
- 논리적 일관성 (발행금액 합계 ≤ 최대 발행한도)

**검증 실패 시**:
- 오류 내용 기록
- 해당 문서 처리 실패로 표시
- 이후 재시도 또는 수동 확인 필요

### 3.6 저장 단계

**목적**: 추출된 데이터를 데이터베이스에 저장

**저장 정보**:

| 저장 위치 | 내용 |
|----------|------|
| 추출 작업 기록 | 접수번호, 처리 상태, 소요 시간, 오류 내용 |
| 기업 정보 | 회사명, 회사 코드 (신규 기업이면 자동 생성) |
| 추출 데이터 요약 | 회사명, 회차 수, 문서 종류 등 핵심 정보 |

---

## 4. 상태 관리

### 4.1 배치 단위 상태

한 번의 모니터링 실행을 하나의 "배치"로 관리.

```
┌─────────────────────────────────────────────┐
│              배치 상태 흐름                   │
├─────────────────────────────────────────────┤
│                                             │
│  실행 중 ──▶ 완료                            │
│     │                                       │
│     ├──▶ 대상 없음 (검색 결과 0건)           │
│     │                                       │
│     └──▶ 실패 (시스템 오류)                  │
│                                             │
└─────────────────────────────────────────────┘
```

**배치 통계**:
- 처리 대상 문서 수
- 성공 건수
- 실패 건수
- 소요 시간

### 4.2 개별 문서 상태

각 문서의 처리 상태를 개별 관리.

```
┌─────────────────────────────────────────────┐
│            개별 문서 상태 흐름                │
├─────────────────────────────────────────────┤
│                                             │
│  대기 ──▶ 처리 중 ──▶ 성공                   │
│                 │                           │
│                 └──▶ 실패 ──▶ 재시도 중      │
│                        │         │          │
│                        │         ▼          │
│                        │       성공         │
│                        │         또는       │
│                        └──────▶ 최종 실패    │
│                              (3회 초과)      │
│                                             │
└─────────────────────────────────────────────┘
```

---

## 5. 오류 처리와 재시도

### 5.1 오류 유형

| 유형 | 원인 예시 | 대응 |
|------|----------|------|
| 다운로드 오류 | 네트워크 문제, API 키 오류 | 자동 재시도 |
| 파싱 오류 | 예상치 못한 문서 구조 | 수동 확인 필요 |
| 검증 오류 | 필수 정보 누락 | 원본 문서 확인 |

### 5.2 자동 재시도

실패한 문서는 자동으로 재시도:

| 재시도 횟수 | 대기 시간 |
|------------|----------|
| 1차 | 5초 |
| 2차 | 15초 |
| 3차 | 30초 |

3회 재시도 후에도 실패하면 "최종 실패"로 표시되며, 수동 확인이 필요함.

### 5.3 오류 기록

실패한 작업에는 다음 정보가 기록됨:
- 오류 종류
- 오류 메시지
- 발생 시점
- 재시도 횟수

---

## 6. 실행 방법

### 6.1 단일 문서 처리

특정 문서 하나만 처리:

```bash
bundle exec rake opendart:download_and_extract[접수번호]

# 예시
bundle exec rake opendart:download_and_extract[20250919000604]
```

**용도**: 특정 문서 테스트, 실패한 문서 재처리

### 6.2 기간별 일괄 처리

지정 기간 내 모든 신규 문서 처리:

```bash
bundle exec rake opendart:monitor_and_extract[시작일,종료일,최대건수]

# 예시: 2025년 10월 1일 ~ 20일, 최대 20건
bundle exec rake opendart:monitor_and_extract[20251001,20251020,20]
```

**용도**: 정기적인 데이터 수집, 과거 데이터 보완

### 6.3 실행 결과 예시

```
================================================================================
DART 모니터링: 증권신고서(채무증권)
================================================================================
조회 기간: 20251001 ~ 20251020
최대 처리: 20건

검색 결과: 5건

[1/5] 삼성전자 - 증권신고서(채무증권)
      접수번호: 20250919000604
      → 처리 완료 (회차 3개, 최초 제출)

[2/5] LG전자 - 증권신고서(채무증권)
      접수번호: 20250920000123
      → 처리 완료 (회차 2개, 발행조건 확정)

... (생략) ...

================================================================================
처리 결과
================================================================================
총 문서: 5건
성공: 5건
실패: 0건
소요 시간: 45초
```

---

## 관련 문서

- **데이터베이스 설계**: [database-design.md](./database-design.md)
- **테이블 스키마**: [database-schema.md](./database-schema.md)

---

**작성일**: 2025-11-27
**버전**: 1.0
